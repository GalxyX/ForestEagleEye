<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>论坛首页</title>
    <style>
        .container {
            display: flex;
            width: 80%;
            margin: 0 auto;
        }
        .hot-posts {
            width: 66%;
            padding-right: 20px;
        }
        .post {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        .post h3 {
            margin: 0;
            font-size: 1.2em;
            color: #333;
        }
        .post p {
            color: #555;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .post-images {
            display: flex;
            margin-top: 10px;
        }
        .post-images img {
            width: 80px;
            height: auto;
            margin-right: 5px;
            object-fit: cover;
            border-radius: 4px;
        }
        .post-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .user-panel {
            width: 33%;
            padding-left: 20px;
            border-left: 1px solid #ddd;
        }
        .user-info {
            text-align: center;
            margin-bottom: 20px;
        }
        .user-info .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
        }
        .post-button a {
            display: inline-block;
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
    </style>
    <script>

        function toggleLike(postId) {
            fetch(`/post/${postId}/like`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert("点赞操作失败：" + data.error);
                        return;
                    }

                    document.querySelectorAll(`[data-post-id="${postId}"] .like-button`).forEach(button => {
                        button.textContent = data.action === 'liked' ? '👎 取消点赞' : '👍 点赞';
                    });
                    document.querySelectorAll(`[data-post-id="${postId}"] .like-count`).forEach(span => {
                        span.textContent = data.like_count;
                    });
                })
                .catch(error => console.error("点赞操作失败:", error));
        }


        function openShareModal(postId) {
            const content = prompt("请输入转发内容：");
            if (content) {
                fetch(`/post/${postId}/share`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert("转发操作失败：" + data.error);
                        return;
                    }
                    alert("转发成功！");
                    location.reload();
                })
                .catch(error => console.error("转发操作失败:", error));
            }
        }
    </script>
</head>
<body>
<div class="container">
    <!-- 左侧热帖展示 -->
    <div class="hot-posts">
        <h2>实时热帖</h2>
        {% for post in posts %}
        <div class="post" data-post-id="{{ post.id }}">

            <div class="post-user">
                <img src="{{ url_for('static', filename=post.author.avatar) }}" alt="Avatar" width="40" height="40" style="border-radius:50%;">
                <a href="{{ url_for('user_profile', username=post.author.username) }}">
                    <span>{{ post.author.username }}</span>
                </a>
            </div>

            {% if post.original_post %}

                <h3>{{ post.author.username }} 转发了帖子:
                    <a href="{{ url_for('post_detail', post_id=post.original_post.id) }}">{{ post.original_post.title }}</a>
                </h3>
            {% else %}

                <h3><a href="{{ url_for('post_detail', post_id=post.id) }}">{{ post.title }}</a></h3>
            {% endif %}

            <p>{{ post.content_preview }}</p>

            <div class="post-images">
                {% for image in post.images %}
                    <img src="{{ url_for('static', filename=image) }}" alt="Post Image">
                {% endfor %}
            </div>

            <div class="post-actions">
                <button class="like-button" onclick="toggleLike({{ post.id }})">
                    {{ "👎 取消点赞" if post.is_liked else "👍 点赞" }}
                </button>
                <span class="like-count">{{ post.like_count }}</span>
                <button onclick="openShareModal({{ post.id }})">🔁 转发</button>
                <a href="{{ url_for('post_detail', post_id=post.id) }}"><button>💬 评论</button></a>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="user-panel">
        <div class="user-info">
            <img src="{{ url_for('static', filename=user.avatar) }}" alt="Avatar" class="avatar">
            <h3><a href="{{ url_for('user_profile', username=user.username) }}">{{ user.username }}</a></h3>
        </div>
        <div class="post-button">
            <a href="{{ url_for('forum_post') }}" class="btn">发布帖子</a>
        </div>
    </div>
</div>
</body>
</html>
